{% extends "base.html" %}

{% block title %}Employee Dashboard{% endblock %}

{% block content %}
    <h1>Employee and Payroll Management Dashboard</h1>

    <div style="display: flex; gap: 20px; margin-top: 30px;">
        <p><a href="{{ url_for('main_dashboard') }} " style="padding: 10px; background-color: gray; color: white; text-decoration: none; border-radius: 4px; font-size: 1.2em; text-align: center;">Back to Application Hub</a></p>

        <p><a href="{{ url_for('add_employee')}}" style="padding: 10px; background-color: skyblue; color: white; text-decoration: none; border-radius: 4px; font-size: 1.2em; text-align: center;">Click here to add an employee</a></p>

        <p><a href="{{ url_for('payroll_history')}}" style="padding: 10px; background-color: purple; color: white; text-decoration: none; border-radius: 4px; font-size: 1.2em; text-align: center;">Click here to view payroll history</a></p>
    </div>

    <p>View employee details and process payroll based on their title or hourly rate.</p>

    <table>
        <thead>
            <tr>
                <th>Employee No.</th>
                <th>Name</th>
                <th>Title</th>
                <th>Phone No.</th>
                <th>Current Project No.</th>
                <th>Project Role</th>
                <th>Project Start Date</th>
                <th>Pay Type</th>
                <th>Payroll Action</th>
                <th>Edit</th>
                <th>Termination</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
            <tr>
                <td>{{ employee.Employee_No }}</td>
                <td>{{ employee.Employee_Name }}</td>
                <td>{{ employee.Title }}</td>
                <td>{{ employee.Phone_Number }}</td>

                {% set active_assignment = None %}
                {% if employee.projects_assigned|length > 0 %}
                    {% set active_assignment = employee.projects_assigned[0] %}
                {% endif %}

                {% set is_active = (active_assignment and (active_assignment.Date_Ended is none or active_assignment.Date_Ended == '')) %}
                
                <td>
                    {% if is_active %}
                        {{ active_assignment.Project_No }}
                    {% else %}
                        <span>Currently not assigned</span>
                    {% endif %}
                </td>
                
                <td>
                    {% if is_active %}
                        {{ active_assignment.Role }}
                    {% else %}
                        <span>—</span>
                    {% endif %}
                </td>

                <td>
                    {% if is_active %}
                        {{ active_assignment.Date_Started.strftime('%Y-%m-%d') if active_assignment.Date_Started else 'N/A' }}
                    {% else %}
                        <span>—</span>
                    {% endif %}
                </td>
                <td>
                    {% if employee.Is_Hourly %}
                        <span style="color: darkorange; font-weight: bold;">Hourly (${{ "%.2f"|format(employee.Hourly_Rate or 0) }})</span>
                    {% else %}
                        Salaried
                    {% endif %}
                </td>
                
                <td>
                    <form action="{{ url_for('generate_payroll', emp_id=employee.Employee_No) }}" method="POST" style="display:inline-flex; align-items: center; gap: 5px;">
                        {% if employee.Is_Hourly %}
                            <input type="number" name="hours" placeholder="Hours" required min="1" step="0.5" style="width: 70px;">
                        {% endif %}
                        <button type="submit" style="background-color: green; color: white; border: none; padding: 5px 10px; cursor: pointer;">
                            Process Pay
                        </button>
                    </form>
                </td>
                <td>
                    <a href = "{{ url_for('edit_employee', emp_id=employee.Employee_No) }}" style="background-color: skyblue; color: white; border: none; padding: 5px 10px; text-decoration: none;">
                        Edit
                    </a>
                </td>
                <td>
                    <form action="{{ url_for('fire_employee', emp_id=employee.Employee_No) }}" method="POST" 
                          onsubmit="return confirm('Are you sure you want to terminate {{ employee.Employee_Name }}? This action still preserves record history.');"
                          style="display:inline-block;">
                        <button type="submit" style="background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer;">
                            Fire Employee
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9">No employees found. <a href="{{ url_for('add_employee') }}">Add one now</a>.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}